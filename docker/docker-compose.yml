version: '3.8'

services:
  # Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: autonvis-rabbitmq
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - autonvis-network

  # State Storage
  redis:
    image: redis:7-alpine
    container_name: autonvis-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: redis-cli ping
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - autonvis-network

  # Data Ingestion Service
  ingestion:
    build:
      context: ..
      dockerfile: docker/ingestion/Dockerfile
    container_name: autonvis-ingestion
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      AUTONVIS_CONFIG: /config/production.yml
      PYTHONUNBUFFERED: 1
    volumes:
      - ../src:/app/src
      - ../config:/config
      - ../data:/data
    networks:
      - autonvis-network
    restart: unless-stopped

  # Supervisor Service
  supervisor:
    build:
      context: ..
      dockerfile: docker/supervisor/Dockerfile
    container_name: autonvis-supervisor
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"  # HTTP API
    environment:
      AUTONVIS_CONFIG: /config/production.yml
      PYTHONUNBUFFERED: 1
    volumes:
      - ../src:/app/src
      - ../config:/config
      - ../data:/data
    networks:
      - autonvis-network
    restart: unless-stopped

  # SR-UKF Assimilation Service (C++)
  assimilation:
    build:
      context: ..
      dockerfile: docker/assimilation/Dockerfile
    container_name: autonvis-assimilation
    depends_on:
      rabbitmq:
        condition: service_healthy
    ports:
      - "50051:50051"  # gRPC port
    environment:
      AUTONVIS_CONFIG: /config/production.yml
    volumes:
      - ../data:/data
    # Uncomment for GPU support
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - autonvis-network
    restart: unless-stopped

  # Output Service (Dashboard & API)
  output:
    build:
      context: ..
      dockerfile: docker/output/Dockerfile
    container_name: autonvis-output
    depends_on:
      - rabbitmq
      - redis
    ports:
      - "8080:8080"  # Web dashboard
    environment:
      AUTONVIS_CONFIG: /config/production.yml
      PYTHONUNBUFFERED: 1
    volumes:
      - ../src:/app/src
      - ../config:/config
      - ../data:/data
    networks:
      - autonvis-network
    restart: unless-stopped

volumes:
  rabbitmq_data:
  redis_data:

networks:
  autonvis-network:
    driver: bridge
